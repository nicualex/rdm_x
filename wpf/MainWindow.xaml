<Window x:Class="RDM_X.MainWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:vm="clr-namespace:RDM_X.ViewModels"
        xmlns:conv="clr-namespace:RDM_X.Converters"
        Title="RDM_X — DMX/RDM Fixture Validator"
        Background="#FF1E1E2E" Foreground="#FFE8E8F0"
        Width="1400" Height="900" WindowStartupLocation="CenterScreen">

    <Window.DataContext>
        <vm:MainViewModel/>
    </Window.DataContext>

    <Window.Resources>
        <conv:StatusToTextConverter x:Key="StatusText"/>
        <conv:StatusToBrushConverter x:Key="StatusBrush"/>
        <conv:LatencyToBrushConverter x:Key="LatencyBrush"/>
        <conv:BoolToVisibilityConverter x:Key="BoolVis"/>
        <conv:InverseBoolToVisibilityConverter x:Key="InvBoolVis"/>
    </Window.Resources>

    <Grid>
        <Grid.ColumnDefinitions>
            <ColumnDefinition Width="260"/>
            <ColumnDefinition Width="*"/>
        </Grid.ColumnDefinitions>
        <Grid.RowDefinitions>
            <RowDefinition Height="*"/>
        </Grid.RowDefinitions>

        <!-- ═══════════════════════════════════════════════════════════════ -->
        <!-- LEFT SIDEBAR                                                    -->
        <!-- ═══════════════════════════════════════════════════════════════ -->
        <Border Grid.Column="0" Grid.Row="0" Background="#FF191928"
                BorderBrush="{StaticResource BorderBrush}" BorderThickness="0,0,1,0"
                Padding="12">
            <ScrollViewer VerticalScrollBarVisibility="Auto">
                <StackPanel>
                    <!-- Connection -->
                    <TextBlock Text="CONNECTION" FontSize="10" FontWeight="Bold"
                               Foreground="{StaticResource TextSecBrush}" Margin="0,0,0,8"/>

                    <Label Content="FTDI Device"/>
                    <Grid>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="Auto"/>
                        </Grid.ColumnDefinitions>
                        <ComboBox ItemsSource="{Binding Devices}"
                                  SelectedIndex="{Binding SelectedDeviceIndex}"
                                  DisplayMemberPath="Label" Margin="0,0,6,0"/>
                        <Button Grid.Column="1" Content="⟳" Style="{StaticResource DarkButton}"
                                Padding="8,5" Command="{Binding RefreshDevicesCommand}"/>
                    </Grid>

                    <Button Content="Connect" Margin="0,8,0,0"
                            Style="{StaticResource AccentButton}"
                            Command="{Binding ConnectCommand}"
                            Visibility="{Binding IsConnected, Converter={StaticResource InvBoolVis}}"
                            HorizontalAlignment="Stretch"/>

                    <StackPanel Visibility="{Binding IsConnected, Converter={StaticResource BoolVis}}">
                        <Border Style="{StaticResource Card}" Margin="0,8,0,0">
                            <StackPanel>
                                <StackPanel Orientation="Horizontal">
                                    <Ellipse Width="8" Height="8" Fill="{StaticResource GreenBrush}" Margin="0,0,6,0"/>
                                    <TextBlock Text="CONNECTED" FontWeight="SemiBold"
                                               Foreground="{StaticResource GreenBrush}"/>
                                </StackPanel>
                                <TextBlock Text="{Binding FirmwareVersion, StringFormat='Firmware: {0}'}"
                                           Foreground="{StaticResource TextSecBrush}" Margin="0,4,0,0"/>
                                <TextBlock Text="{Binding SerialNumber, StringFormat='SN: {0}'}"
                                           Foreground="{StaticResource TextSecBrush}"/>
                            </StackPanel>
                        </Border>
                        <Button Content="Disconnect" Margin="0,6,0,0"
                                Style="{StaticResource DarkButton}"
                                Command="{Binding DisconnectCommand}"
                                HorizontalAlignment="Stretch"/>
                    </StackPanel>

                    <!-- Discovery -->
                    <TextBlock Text="RDM DISCOVERY" FontSize="10" FontWeight="Bold"
                               Foreground="{StaticResource TextSecBrush}" Margin="0,20,0,8"/>

                    <Button Content="🔍  Discover Devices" Margin="0,0,0,6"
                            Style="{StaticResource AccentButton}"
                            Command="{Binding DiscoverCommand}"
                            IsEnabled="{Binding IsConnected}"
                            HorizontalAlignment="Stretch"/>

                    <TextBlock Text="{Binding BusyText}" FontStyle="Italic"
                               Foreground="{StaticResource YellowBrush}"
                               TextWrapping="Wrap" Margin="0,0,0,6"
                               MinHeight="32"/>

                    <TextBlock Text="Discovered Devices" FontSize="11"
                               Foreground="{StaticResource TextSecBrush}" Margin="0,4,0,4"/>

                    <ListBox ItemsSource="{Binding DiscoveredUIDs}"
                             SelectedItem="{Binding SelectedUID}"
                             DisplayMemberPath="Display"
                             MinHeight="60" MaxHeight="200"/>

                    <!-- Device Control (DMXster Phase 1) -->
                    <TextBlock Text="DEVICE CONTROL" FontSize="10" FontWeight="Bold"
                               Foreground="{StaticResource TextSecBrush}" Margin="0,20,0,8"/>

                    <Button Margin="0,0,0,6" HorizontalAlignment="Stretch"
                            Command="{Binding ToggleIdentifyCommand}"
                            IsEnabled="{Binding HasSelectedFixture}">
                        <Button.Style>
                            <Style TargetType="Button" BasedOn="{StaticResource DarkButton}">
                                <Setter Property="Content" Value="💡  Identify OFF"/>
                                <Style.Triggers>
                                    <DataTrigger Binding="{Binding IdentifyActive}" Value="True">
                                        <Setter Property="Content" Value="💡  Identify ON"/>
                                        <Setter Property="Background" Value="#FF2C5F2C"/>
                                        <Setter Property="Foreground" Value="{StaticResource GreenBrush}"/>
                                    </DataTrigger>
                                </Style.Triggers>
                            </Style>
                        </Button.Style>
                    </Button>

                    <Label Content="DMX Start Address"/>
                    <Grid Margin="0,0,0,6">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="Auto"/>
                            <ColumnDefinition Width="Auto"/>
                        </Grid.ColumnDefinitions>
                        <TextBox Text="{Binding DmxAddressInput, UpdateSourceTrigger=PropertyChanged}"
                                 VerticalAlignment="Center"/>
                        <Button Grid.Column="1" Content="GET" Style="{StaticResource DarkButton}"
                                Padding="8,4" Margin="4,0,0,0" FontSize="11"
                                Command="{Binding GetDmxAddressCommand}" IsEnabled="{Binding HasSelectedFixture}"/>
                        <Button Grid.Column="2" Content="SET" Style="{StaticResource AccentButton}"
                                Padding="8,4" Margin="4,0,0,0" FontSize="11"
                                Command="{Binding SetDmxAddressCommand}" IsEnabled="{Binding HasSelectedFixture}"/>
                    </Grid>
                    <TextBlock Text="{Binding DmxStartAddress, StringFormat='Current: {0}'}"
                               FontSize="11" Foreground="{StaticResource TextSecBrush}" Margin="0,0,0,4"/>

                    <TextBlock Text="{Binding DeviceInfoText}" FontSize="10"
                               FontFamily="Cascadia Code, Consolas"
                               Foreground="{StaticResource CyanBrush}"
                               TextWrapping="Wrap" Margin="0,0,0,8"/>                    <!-- Compliance Scorecard -->
                    <TextBlock Text="COMPLIANCE" FontSize="10" FontWeight="Bold"
                               Foreground="{StaticResource TextSecBrush}" Margin="0,20,0,8"/>

                    <Border Style="{StaticResource Card}">
                        <Grid>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="*"/>
                            </Grid.ColumnDefinitions>
                            <Grid.RowDefinitions>
                                <RowDefinition/>
                                <RowDefinition/>
                            </Grid.RowDefinitions>
                            <StackPanel Grid.Column="0" Grid.Row="0" Margin="0,0,0,6">
                                <TextBlock Text="{Binding PassCount}" FontSize="22" FontWeight="Bold"
                                           Foreground="{StaticResource GreenBrush}"/>
                                <TextBlock Text="PASS" FontSize="10" Foreground="{StaticResource TextSecBrush}"/>
                            </StackPanel>
                            <StackPanel Grid.Column="1" Grid.Row="0" Margin="0,0,0,6">
                                <TextBlock Text="{Binding WarnCount}" FontSize="22" FontWeight="Bold"
                                           Foreground="{StaticResource YellowBrush}"/>
                                <TextBlock Text="WARN" FontSize="10" Foreground="{StaticResource TextSecBrush}"/>
                            </StackPanel>
                            <StackPanel Grid.Column="0" Grid.Row="1">
                                <TextBlock Text="{Binding FailCount}" FontSize="22" FontWeight="Bold"
                                           Foreground="{StaticResource RedBrush}"/>
                                <TextBlock Text="FAIL" FontSize="10" Foreground="{StaticResource TextSecBrush}"/>
                            </StackPanel>
                            <StackPanel Grid.Column="1" Grid.Row="1">
                                <TextBlock Text="{Binding TimeoutCount}" FontSize="22" FontWeight="Bold"
                                           Foreground="{StaticResource TextSecBrush}"/>
                                <TextBlock Text="TIMEOUT" FontSize="10" Foreground="{StaticResource TextSecBrush}"/>
                            </StackPanel>
                        </Grid>
                    </Border>

                    <!-- ── DMX Status ─────────────────────────── -->
                    <TextBlock Text="DMX STATUS" FontSize="10" FontWeight="Bold"
                               Foreground="{StaticResource TextSecBrush}" Margin="0,20,0,8"/>

                    <!-- Connection indicator -->
                    <StackPanel Orientation="Horizontal" Margin="0,0,0,8">
                        <Ellipse Width="8" Height="8" Margin="0,0,6,0">
                            <Ellipse.Style>
                                <Style TargetType="Ellipse">
                                    <Setter Property="Fill" Value="{StaticResource RedBrush}"/>
                                    <Style.Triggers>
                                        <DataTrigger Binding="{Binding IsConnected}" Value="True">
                                            <Setter Property="Fill" Value="{StaticResource GreenBrush}"/>
                                        </DataTrigger>
                                    </Style.Triggers>
                                </Style>
                            </Ellipse.Style>
                        </Ellipse>
                        <TextBlock FontSize="11" Foreground="{StaticResource TextSecBrush}">
                            <TextBlock.Style>
                                <Style TargetType="TextBlock">
                                    <Setter Property="Text" Value="Disconnected"/>
                                    <Style.Triggers>
                                        <DataTrigger Binding="{Binding IsConnected}" Value="True">
                                            <Setter Property="Text" Value="Connected"/>
                                        </DataTrigger>
                                    </Style.Triggers>
                                </Style>
                            </TextBlock.Style>
                        </TextBlock>
                        <TextBlock FontSize="10" Foreground="{StaticResource TextSecBrush}"
                                   VerticalAlignment="Center" Margin="12,0,0,0">
                            <Run Text="TX:"/>
                            <Run Text="{Binding DmxFrameCount, Mode=OneWay}" FontWeight="Bold"
                                 Foreground="{StaticResource CyanBrush}"/>
                        </TextBlock>
                    </StackPanel>

                    <!-- DMX Level slider -->
                    <StackPanel Orientation="Horizontal" Margin="0,0,0,8">
                        <TextBlock Text="DMX:" FontSize="11" Foreground="{StaticResource TextSecBrush}"
                                   VerticalAlignment="Center" Margin="0,0,6,0"/>
                        <Slider Width="140" Minimum="0" Maximum="255"
                                Value="{Binding DmxLevel}" VerticalAlignment="Center"/>
                        <TextBlock Text="{Binding DmxLevel}" FontSize="11" FontWeight="SemiBold"
                                   Foreground="{StaticResource AccentBrush}"
                                   VerticalAlignment="Center" Width="30" Margin="6,0,0,0"/>
                    </StackPanel>

                    <!-- Broadcast checkbox -->
                    <CheckBox Content="Broadcast" IsChecked="{Binding DmxBroadcast}"
                              Foreground="{StaticResource TextSecBrush}" FontSize="11"
                              Margin="0,0,0,4"/>

                    <!-- Busy text -->
                    <TextBlock Text="{Binding BusyText}" FontSize="11"
                               FontStyle="Italic" Foreground="{StaticResource YellowBrush}"
                               Margin="0,0,0,4"/>
                </StackPanel>
            </ScrollViewer>
        </Border>

        <!-- ═══════════════════════════════════════════════════════════════ -->
        <!-- MAIN CONTENT (TABS)                                             -->
        <!-- ═══════════════════════════════════════════════════════════════ -->
        <TabControl Grid.Column="1" Grid.Row="0" Margin="0">

            <!-- ─── TAB 1: PID EXPLORER ─── -->
            <TabItem Header="📋  PID Explorer">
                <Grid Margin="12">
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="*"/>
                        <RowDefinition Height="Auto"/>
                    </Grid.RowDefinitions>

                    <!-- Action bar -->
                    <StackPanel Orientation="Horizontal" Margin="0,0,0,10">
                        <Button Content="▶  Query All GETs" Style="{StaticResource AccentButton}"
                                Command="{Binding QueryAllPidsCommand}" Margin="0,0,8,0"
                                IsEnabled="{Binding HasSelectedFixture}"/>
                        <Button Content="🔎  Query Supported PIDs" Style="{StaticResource DarkButton}"
                                Command="{Binding QuerySupportedPidsCommand}" Margin="0,0,8,0"
                                IsEnabled="{Binding HasSelectedFixture}"/>
                        <Button Content="Query Selected" Style="{StaticResource DarkButton}"
                                Command="{Binding QuerySelectedPidCommand}" Margin="0,0,8,0"
                                IsEnabled="{Binding HasSelectedFixture}"/>
                        <Button Content="Send SET" Style="{StaticResource DarkButton}"
                                Command="{Binding SendSetCommand}" Margin="0,0,8,0"
                                IsEnabled="{Binding HasSelectedFixture}"/>
                        <Button Content="📥  Export CSV" Style="{StaticResource DarkButton}"
                                Command="{Binding ExportCsvCommand}" Margin="0,0,8,0"/>
                        <Label Content="Payload (hex):" VerticalAlignment="Center" Margin="8,0,4,0"/>
                        <TextBox Text="{Binding CustomPayloadHex, UpdateSourceTrigger=PropertyChanged}"
                                 Width="200" VerticalAlignment="Center"/>
                    </StackPanel>

                    <!-- PID DataGrid -->
                    <DataGrid Grid.Row="1"
                              ItemsSource="{Binding PidResults}"
                              SelectedItem="{Binding SelectedPid}">
                        <DataGrid.Columns>
                            <DataGridTextColumn Header="PID" Width="80"
                                Binding="{Binding Pid, StringFormat=0x{0:X4}}"/>
                            <DataGridTextColumn Header="Name" Width="220" Binding="{Binding Name}"/>
                            <DataGridTextColumn Header="Class" Width="80" Binding="{Binding CmdClass}"/>
                            <DataGridTemplateColumn Header="Mandatory" Width="75">
                                <DataGridTemplateColumn.CellTemplate>
                                    <DataTemplate>
                                        <TextBlock Text="{Binding IsMandatory}"
                                                   Foreground="{StaticResource YellowBrush}"
                                                   FontWeight="SemiBold"/>
                                    </DataTemplate>
                                </DataGridTemplateColumn.CellTemplate>
                            </DataGridTemplateColumn>
                            <DataGridTemplateColumn Header="Supported" Width="85">
                                <DataGridTemplateColumn.CellTemplate>
                                    <DataTemplate>
                                        <TextBlock Text="{Binding SupportedStatus}"
                                                   FontWeight="SemiBold" FontSize="11"/>
                                    </DataTemplate>
                                </DataGridTemplateColumn.CellTemplate>
                            </DataGridTemplateColumn>
                            <DataGridTemplateColumn Header="Status" Width="90">
                                <DataGridTemplateColumn.CellTemplate>
                                    <DataTemplate>
                                        <TextBlock Text="{Binding Status, Converter={StaticResource StatusText}}"
                                                   Foreground="{Binding Status, Converter={StaticResource StatusBrush}}"
                                                   FontWeight="SemiBold"/>
                                    </DataTemplate>
                                </DataGridTemplateColumn.CellTemplate>
                            </DataGridTemplateColumn>
                            <DataGridTemplateColumn Header="Latency" Width="90">
                                <DataGridTemplateColumn.CellTemplate>
                                    <DataTemplate>
                                        <TextBlock Text="{Binding LatencyUs, StringFormat={}{0}μs}"
                                                   Foreground="{Binding LatencyUs, Converter={StaticResource LatencyBrush}}"
                                                   FontFamily="Cascadia Code, Consolas" FontSize="11"/>
                                    </DataTemplate>
                                </DataGridTemplateColumn.CellTemplate>
                            </DataGridTemplateColumn>
                            <DataGridTextColumn Header="Value / Response" Width="*" Binding="{Binding Value}"/>
                        </DataGrid.Columns>
                    </DataGrid>

                    <!-- Detail panel -->
                    <Border Grid.Row="2" Style="{StaticResource Card}" Margin="0,10,0,0"
                            Visibility="{Binding SelectedPid, Converter={StaticResource BoolVis}}">
                        <StackPanel>
                            <TextBlock FontSize="12" FontWeight="SemiBold"
                                       Foreground="{StaticResource AccentBrush}">
                                <Run Text="PID 0x"/><Run Text="{Binding SelectedPid.Pid, StringFormat={}{0:X4}, Mode=OneWay}"/>
                                <Run Text=" — "/><Run Text="{Binding SelectedPid.Name, Mode=OneWay}"/>
                            </TextBlock>
                            <TextBlock Text="{Binding SelectedPid.RawHex, StringFormat='Raw: {0}', Mode=OneWay}"
                                       FontFamily="Cascadia Code, Consolas" FontSize="12"
                                       Foreground="{StaticResource TextSecBrush}" Margin="0,4,0,0"
                                       TextWrapping="Wrap"/>
                        </StackPanel>
                    </Border>
                </Grid>
            </TabItem>

            <!-- ─── TAB 3: DMX OUTPUT ─── -->
            <TabItem Header="🎚  DMX Output">
                <Grid Margin="12">
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="*"/>
                    </Grid.RowDefinitions>

                    <!-- Consolidated Toolbar -->
                    <Border Background="#FF252540" CornerRadius="6" Padding="10,8" Margin="0,0,0,10">
                        <StackPanel>
                            <DockPanel Margin="0,0,0,6">
                                <!-- Left: Title + ADDR/FP -->
                                <StackPanel Orientation="Horizontal" VerticalAlignment="Center">
                                    <TextBlock Text="DMX OUTPUT" FontSize="14" FontWeight="Bold"
                                               Foreground="{StaticResource AccentBrush}" Margin="0,0,16,0"
                                               VerticalAlignment="Center"/>
                                    <Border Background="#FF1E1E2E" CornerRadius="4" Padding="10,4" Margin="0,0,6,0">
                                        <TextBlock FontSize="12" FontFamily="Cascadia Code, Consolas">
                                            <Run Text="ADDR " Foreground="{StaticResource TextSecBrush}"/>
                                            <Run Text="{Binding DmxStartAddress, Mode=OneWay}" FontWeight="Bold" FontSize="14"
                                                 Foreground="{StaticResource CyanBrush}"/>
                                        </TextBlock>
                                    </Border>
                                    <Border Background="#FF1E1E2E" CornerRadius="4" Padding="10,4">
                                        <TextBlock FontSize="12" FontFamily="Cascadia Code, Consolas">
                                            <Run Text="FP " Foreground="{StaticResource TextSecBrush}"/>
                                            <Run Text="{Binding DmxFootprint, Mode=OneWay}" FontWeight="Bold" FontSize="14"
                                                 Foreground="{StaticResource AccentBrush}"/>
                                            <Run Text=" ch" Foreground="{StaticResource TextSecBrush}"/>
                                        </TextBlock>
                                    </Border>
                                </StackPanel>
                            </DockPanel>

                            <!-- Separator -->
                            <Border Height="1" Background="#FF3E3E58" Margin="0,2,0,6"/>

                            <!-- Row 2: Refresh Rate, Auto-Fade, Chase, Stop -->
                            <StackPanel Orientation="Horizontal" VerticalAlignment="Center">
                                <!-- Refresh Rate -->
                                <Slider Width="80" Minimum="1" Maximum="44"
                                        Value="{Binding DmxRefreshRate}" VerticalAlignment="Center"/>
                                <TextBlock VerticalAlignment="Center" FontFamily="Cascadia Code, Consolas"
                                           FontSize="11" Margin="4,0,20,0">
                                    <Run Text="{Binding DmxRefreshRate, Mode=OneWay}" FontWeight="Bold"
                                         Foreground="{StaticResource AccentBrush}"/>
                                    <Run Text="Hz" Foreground="{StaticResource TextSecBrush}"/>
                                </TextBlock>

                                <!-- Separator -->
                                <Border Width="1" Height="20" Background="#FF3E3E58" Margin="0,0,20,0"/>

                                <!-- Auto-Fade -->
                                <TextBlock Text="Fade" FontSize="10" FontWeight="Bold"
                                           Foreground="{StaticResource TextSecBrush}" VerticalAlignment="Center"
                                           Margin="0,0,8,0"/>
                                <TextBox Text="{Binding FadeFrom, UpdateSourceTrigger=PropertyChanged}"
                                         Width="35" FontSize="11" VerticalAlignment="Center" Margin="0,0,6,0"/>
                                <TextBlock Text="→" FontSize="11" Foreground="{StaticResource TextSecBrush}"
                                           VerticalAlignment="Center" Margin="0,0,6,0"/>
                                <TextBox Text="{Binding FadeTo, UpdateSourceTrigger=PropertyChanged}"
                                         Width="35" FontSize="11" VerticalAlignment="Center" Margin="0,0,6,0"/>
                                <TextBlock Text="/" FontSize="11" Foreground="{StaticResource TextSecBrush}"
                                           VerticalAlignment="Center" Margin="0,0,6,0"/>
                                <TextBox Text="{Binding FadeDuration, UpdateSourceTrigger=PropertyChanged}"
                                         Width="32" FontSize="11" VerticalAlignment="Center" Margin="0,0,2,0"/>
                                <TextBlock Text="s" FontSize="10" Foreground="{StaticResource TextSecBrush}"
                                           VerticalAlignment="Center" Margin="0,0,8,0"/>
                                <Button Content="▶ Fade" Style="{StaticResource AccentButton}"
                                        Command="{Binding AutoFadeCommand}" Padding="8,3"
                                        FontSize="11" Margin="0,0,20,0"
                                        IsEnabled="{Binding IsConnected}"/>

                                <!-- Separator -->
                                <Border Width="1" Height="20" Background="#FF3E3E58" Margin="0,0,20,0"/>

                                <!-- Chase -->
                                <TextBlock Text="Chase" FontSize="10" FontWeight="Bold"
                                           Foreground="{StaticResource TextSecBrush}" VerticalAlignment="Center"
                                           Margin="0,0,8,0"/>
                                <TextBox Text="{Binding ChaseDwell, UpdateSourceTrigger=PropertyChanged}"
                                         Width="35" FontSize="11" VerticalAlignment="Center" Margin="0,0,2,0"/>
                                <TextBlock Text="s" FontSize="10" Foreground="{StaticResource TextSecBrush}"
                                           VerticalAlignment="Center" Margin="0,0,8,0"/>
                                <Button Content="▶ Chase" Style="{StaticResource AccentButton}"
                                        Command="{Binding ChaseCommand}" Padding="8,3"
                                        FontSize="11" Margin="0,0,12,0"
                                        IsEnabled="{Binding IsConnected}"/>

                                <!-- Stop -->
                                <Button Content="⏹ Stop" Padding="10,3" FontSize="11"
                                        Command="{Binding StopEffectCommand}"
                                        FontWeight="Bold" BorderThickness="0" Margin="0,0,10,0">
                                    <Button.Style>
                                        <Style TargetType="Button">
                                            <Setter Property="Background" Value="#FF4DD0E1"/>
                                            <Setter Property="Foreground" Value="White"/>
                                            <Setter Property="Template">
                                                <Setter.Value>
                                                    <ControlTemplate TargetType="Button">
                                                        <Border Background="{TemplateBinding Background}"
                                                                CornerRadius="4" Padding="{TemplateBinding Padding}">
                                                            <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center"/>
                                                        </Border>
                                                    </ControlTemplate>
                                                </Setter.Value>
                                            </Setter>
                                            <Style.Triggers>
                                                <Trigger Property="IsMouseOver" Value="True">
                                                    <Setter Property="Background" Value="#FF80DEEA"/>
                                                </Trigger>
                                                <Trigger Property="IsEnabled" Value="False">
                                                    <Setter Property="Background" Value="#FF3A3A50"/>
                                                    <Setter Property="Foreground" Value="#FF666680"/>
                                                </Trigger>
                                            </Style.Triggers>
                                        </Style>
                                    </Button.Style>
                                </Button>

                                <!-- Effect Status -->
                                <TextBlock Text="{Binding EffectStatus}" FontSize="10"
                                           FontStyle="Italic" Foreground="{StaticResource CyanBrush}"
                                           VerticalAlignment="Center"/>
                            </StackPanel>
                        </StackPanel>
                    </Border>

                    <!-- Fader panel -->
                    <ScrollViewer Grid.Row="1" HorizontalScrollBarVisibility="Auto"
                                  VerticalScrollBarVisibility="Disabled" VerticalAlignment="Top">
                        <StackPanel Orientation="Horizontal">
                            <!-- All Zero / All Full buttons -->
                            <StackPanel VerticalAlignment="Center" Margin="0,0,6,0" Width="52">
                                <Button Content="Full" Style="{StaticResource AccentButton}"
                                        Command="{Binding DmxAllFullCommand}"
                                        Padding="4,6" FontSize="10" Margin="2,0,2,4"
                                        IsEnabled="{Binding IsConnected}"/>
                                <Button Content="Zero" Style="{StaticResource DarkButton}"
                                        Command="{Binding DmxAllZeroCommand}"
                                        Padding="4,6" FontSize="10" Margin="2,0,2,0"
                                        IsEnabled="{Binding IsConnected}"/>
                            </StackPanel>

                            <ItemsControl ItemsSource="{Binding DmxChannels}">
                            <ItemsControl.ItemsPanel>
                                <ItemsPanelTemplate>
                                    <StackPanel Orientation="Horizontal"/>
                                </ItemsPanelTemplate>
                            </ItemsControl.ItemsPanel>
                            <ItemsControl.ItemTemplate>
                                <DataTemplate>
                                    <Border Background="#FF252540" CornerRadius="6"
                                            Padding="4,8" Margin="2,0" Width="52">
                                        <StackPanel HorizontalAlignment="Center">
                                            <TextBlock Text="{Binding Level, StringFormat='{}{0}'}" FontSize="11"
                                                       FontFamily="Cascadia Code, Consolas"
                                                       Foreground="{StaticResource AccentBrush}"
                                                       HorizontalAlignment="Center" Margin="0,0,0,4"/>
                                            <Slider Minimum="0" Maximum="255" Orientation="Vertical"
                                                    Height="100"
                                                    Value="{Binding Level, Mode=TwoWay}"
                                                    TickFrequency="16" IsSnapToTickEnabled="False"/>
                                            <TextBlock Text="{Binding Label}" FontSize="9"
                                                       Foreground="{StaticResource TextSecBrush}"
                                                       HorizontalAlignment="Center" Margin="0,4,0,0"/>
                                        </StackPanel>
                                    </Border>
                                </DataTemplate>
                            </ItemsControl.ItemTemplate>
                        </ItemsControl>
                        </StackPanel>
                    </ScrollViewer>
                </Grid>
            </TabItem>

            <!-- ─── TAB 4: TIMING ANALYSIS ─── -->
            <TabItem Header="⏱  Timing">
                <Grid Margin="12">
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="*"/>
                    </Grid.RowDefinitions>

                    <TextBlock Text="Per-PID Response Latency" FontSize="16" FontWeight="SemiBold"
                               Foreground="{StaticResource AccentBrush}" Margin="0,0,0,12"/>

                    <!-- Latency bars (simple ItemsControl-based chart) -->
                    <ScrollViewer Grid.Row="1" VerticalScrollBarVisibility="Auto">
                        <ItemsControl ItemsSource="{Binding PidResults}">
                            <ItemsControl.ItemTemplate>
                                <DataTemplate>
                                    <Grid Margin="0,1" Height="22">
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="200"/>
                                            <ColumnDefinition Width="*"/>
                                            <ColumnDefinition Width="80"/>
                                        </Grid.ColumnDefinitions>
                                        <TextBlock Grid.Column="0" VerticalAlignment="Center"
                                                   FontSize="11" Foreground="{StaticResource TextSecBrush}">
                                            <Run Text="0x"/><Run Text="{Binding Pid, StringFormat={}{0:X4}, Mode=OneWay}"/>
                                            <Run Text=" "/><Run Text="{Binding Name, Mode=OneWay}"/>
                                        </TextBlock>
                                        <!-- Bar -->
                                        <Border Grid.Column="1" Background="#FF252540" CornerRadius="3"
                                                Height="14" HorizontalAlignment="Stretch">
                                            <Border CornerRadius="3" HorizontalAlignment="Left"
                                                    Background="{Binding LatencyUs, Converter={StaticResource LatencyBrush}}"
                                                    MinWidth="2">
                                                <Border.Width>
                                                    <Binding Path="LatencyUs">
                                                        <Binding.Converter>
                                                            <conv:LatencyToWidthConverter/>
                                                        </Binding.Converter>
                                                    </Binding>
                                                </Border.Width>
                                            </Border>
                                        </Border>
                                        <TextBlock Grid.Column="2" VerticalAlignment="Center"
                                                   HorizontalAlignment="Right" FontSize="11"
                                                   FontFamily="Cascadia Code, Consolas"
                                                   Foreground="{Binding LatencyUs, Converter={StaticResource LatencyBrush}}">
                                            <Run Text="{Binding LatencyUs, StringFormat={}{0:F0}, Mode=OneWay}"/><Run Text="μs"/>
                                        </TextBlock>
                                    </Grid>
                                </DataTemplate>
                            </ItemsControl.ItemTemplate>
                        </ItemsControl>
                    </ScrollViewer>
                </Grid>
            </TabItem>

            <!-- ─── TAB 3: PROTOCOL LOG ─── -->
            <TabItem Header="📜  Protocol Log">
                <Grid Margin="12">
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="*"/>
                    </Grid.RowDefinitions>

                    <StackPanel Orientation="Horizontal" Margin="0,0,0,8">
                        <Button Content="Clear Log" Style="{StaticResource DarkButton}"
                                Command="{Binding ClearLogCommand}" Margin="0,0,8,0"/>
                        <Button Content="📋  Copy Log" Style="{StaticResource DarkButton}"
                                Command="{Binding CopyLogCommand}"/>
                    </StackPanel>

                    <ListBox Grid.Row="1" ItemsSource="{Binding LogEntries}"
                             FontFamily="Cascadia Code, Consolas" FontSize="11"
                             VirtualizingStackPanel.IsVirtualizing="True"
                             ScrollViewer.CanContentScroll="True">
                        <ListBox.ItemTemplate>
                            <DataTemplate>
                                <StackPanel Orientation="Horizontal">
                                    <TextBlock Text="{Binding TimeStr}" Width="70"
                                               Foreground="{StaticResource TextSecBrush}"/>
                                    <TextBlock Text="{Binding Direction}" Width="30" FontWeight="SemiBold">
                                        <TextBlock.Style>
                                            <Style TargetType="TextBlock">
                                                <Setter Property="Foreground" Value="{StaticResource GreenBrush}"/>
                                                <Style.Triggers>
                                                    <DataTrigger Binding="{Binding IsTX}" Value="True">
                                                        <Setter Property="Foreground" Value="{StaticResource CyanBrush}"/>
                                                    </DataTrigger>
                                                </Style.Triggers>
                                            </Style>
                                        </TextBlock.Style>
                                    </TextBlock>
                                    <TextBlock Text="{Binding Hex}" Foreground="{StaticResource TextBrush}"/>
                                </StackPanel>
                            </DataTemplate>
                        </ListBox.ItemTemplate>
                    </ListBox>
                </Grid>
            </TabItem>

            <!-- ─── TAB 6: TEST SUITE ─── -->
            <TabItem Header="🔬  Test Suite">
                <ScrollViewer VerticalScrollBarVisibility="Auto" Margin="12">
                    <StackPanel>
                        <TextBlock Text="Test Suite" FontSize="18" FontWeight="SemiBold"
                                   Foreground="{StaticResource AccentBrush}" Margin="0,0,0,12"/>

                        <!-- ── Flicker Finder ── -->
                        <Border Style="{StaticResource Card}" Margin="0,0,0,10">
                            <StackPanel>
                                <TextBlock Text="🔍 FLICKER FINDER" FontSize="12" FontWeight="Bold"
                                           Foreground="{StaticResource CyanBrush}" Margin="0,0,0,6"/>
                                <TextBlock Text="Monitors DMX output timing for jitter and failed sends."
                                           FontSize="11" Foreground="{StaticResource TextSecBrush}" Margin="0,0,0,8"/>
                                <StackPanel Orientation="Horizontal" Margin="0,0,0,8">
                                    <TextBlock Text="Duration:" FontSize="11" VerticalAlignment="Center"
                                               Foreground="{StaticResource TextSecBrush}" Margin="0,0,6,0"/>
                                    <TextBox Text="{Binding FlickerDuration, UpdateSourceTrigger=PropertyChanged}"
                                             Width="50" FontSize="11" VerticalAlignment="Center"/>
                                    <TextBlock Text="seconds" FontSize="11" VerticalAlignment="Center"
                                               Foreground="{StaticResource TextSecBrush}" Margin="6,0,12,0"/>
                                    <Button Content="▶ Start Flicker Test" Style="{StaticResource AccentButton}"
                                            Command="{Binding FlickerFinderCommand}" Padding="12,4"
                                            FontSize="11" IsEnabled="{Binding IsConnected}"/>
                                    <Button Content="⏹ Stop" Style="{StaticResource DarkButton}"
                                            Command="{Binding StopEffectCommand}" Padding="10,4"
                                            FontSize="11" Margin="6,0,0,0"
                                            IsEnabled="{Binding FlickerRunning}"/>
                                </StackPanel>
                                <TextBlock Text="{Binding FlickerResult}" FontSize="12"
                                           FontFamily="Cascadia Code, Consolas"
                                           Foreground="{StaticResource TextBrush}"
                                           TextWrapping="Wrap"/>
                            </StackPanel>
                        </Border>

                        <!-- ── RDM Stress Test ── -->
                        <Border Style="{StaticResource Card}" Margin="0,0,0,10">
                            <StackPanel>
                                <TextBlock Text="⚡ RDM STRESS TEST" FontSize="12" FontWeight="Bold"
                                           Foreground="{StaticResource YellowBrush}" Margin="0,0,0,6"/>
                                <TextBlock Text="Sends rapid GET queries to the selected PID to test RDM responder robustness."
                                           FontSize="11" Foreground="{StaticResource TextSecBrush}" Margin="0,0,0,8"/>
                                <StackPanel Orientation="Horizontal" Margin="0,0,0,8">
                                    <TextBlock Text="PID:" FontSize="11" VerticalAlignment="Center"
                                               Foreground="{StaticResource TextSecBrush}" Margin="0,0,6,0"/>
                                    <ComboBox ItemsSource="{Binding PidResults}"
                                              SelectedItem="{Binding SelectedPid}"
                                              Width="200" FontSize="11" VerticalAlignment="Center" Margin="0,0,12,0">
                                        <ComboBox.ItemTemplate>
                                            <DataTemplate>
                                                <TextBlock>
                                                    <Run Text="0x"/><Run Text="{Binding Pid, StringFormat={}{0:X4}, Mode=OneWay}"/>
                                                    <Run Text=" "/><Run Text="{Binding Name, Mode=OneWay}"/>
                                                </TextBlock>
                                            </DataTemplate>
                                        </ComboBox.ItemTemplate>
                                    </ComboBox>
                                    <TextBlock Text="Iterations:" FontSize="11" VerticalAlignment="Center"
                                               Foreground="{StaticResource TextSecBrush}" Margin="0,0,6,0"/>
                                    <TextBox Text="{Binding StressIterations, UpdateSourceTrigger=PropertyChanged}"
                                             Width="60" FontSize="11" VerticalAlignment="Center"/>
                                    <Button Content="▶ Start RDM Stress" Style="{StaticResource AccentButton}"
                                            Command="{Binding RdmStressTestCommand}" Padding="12,4"
                                            FontSize="11" Margin="12,0,0,0"
                                            IsEnabled="{Binding HasSelectedFixture}"/>
                                    <Button Content="⏹ Stop" Style="{StaticResource DarkButton}"
                                            Command="{Binding StopEffectCommand}" Padding="10,4"
                                            FontSize="11" Margin="6,0,0,0"
                                            IsEnabled="{Binding RdmStressRunning}"/>
                                </StackPanel>
                                <TextBlock Text="{Binding RdmStressResult}" FontSize="12"
                                           FontFamily="Cascadia Code, Consolas"
                                           Foreground="{StaticResource TextBrush}"
                                           TextWrapping="Wrap"/>
                            </StackPanel>
                        </Border>

                        <!-- ── DMX Stress Test ── -->
                        <Border Style="{StaticResource Card}" Margin="0,0,0,10">
                            <StackPanel>
                                <TextBlock Text="💥 DMX STRESS TEST" FontSize="12" FontWeight="Bold"
                                           Foreground="{StaticResource RedBrush}" Margin="0,0,0,6"/>
                                <TextBlock Text="Sends alternating 0/255 DMX frames at maximum rate to stress-test the link."
                                           FontSize="11" Foreground="{StaticResource TextSecBrush}" Margin="0,0,0,8"/>
                                <StackPanel Orientation="Horizontal" Margin="0,0,0,8">
                                    <TextBlock Text="Duration:" FontSize="11" VerticalAlignment="Center"
                                               Foreground="{StaticResource TextSecBrush}" Margin="0,0,6,0"/>
                                    <TextBox Text="{Binding DmxStressDuration, UpdateSourceTrigger=PropertyChanged}"
                                             Width="50" FontSize="11" VerticalAlignment="Center"/>
                                    <TextBlock Text="seconds" FontSize="11" VerticalAlignment="Center"
                                               Foreground="{StaticResource TextSecBrush}" Margin="6,0,12,0"/>
                                    <Button Content="▶ Start DMX Stress" Style="{StaticResource AccentButton}"
                                            Command="{Binding DmxStressTestCommand}" Padding="12,4"
                                            FontSize="11" IsEnabled="{Binding IsConnected}"/>
                                    <Button Content="⏹ Stop" Style="{StaticResource DarkButton}"
                                            Command="{Binding StopEffectCommand}" Padding="10,4"
                                            FontSize="11" Margin="6,0,0,0"
                                            IsEnabled="{Binding DmxStressRunning}"/>
                                </StackPanel>
                                <TextBlock Text="{Binding DmxStressResult}" FontSize="12"
                                           FontFamily="Cascadia Code, Consolas"
                                           Foreground="{StaticResource TextBrush}"
                                           TextWrapping="Wrap"/>
                            </StackPanel>
                        </Border>
                    </StackPanel>
                </ScrollViewer>
            </TabItem>
        </TabControl>

    </Grid>
</Window>
